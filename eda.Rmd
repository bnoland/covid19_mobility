---
title: "Exploratory Data Analysis"
output: html_notebook
date: 2020-05-11
---

```{r setup, include=FALSE}
source("code/packages.R")

knitr::opts_chunk$set(
  echo = FALSE,
  fig.width = 6,
  fig.asp = 0.618,
  out.width = "70%",
  fig.align = "center",
  fig.show = "hold",
  eval = TRUE
)

loadd(
  raw_us_data,
  us_data,
  pop_density_data,
  state_level_data,
  rt_data,
  rf_model_list
)
```

```{r raw-us-missing-values}
raw_us_data %>%
  map(~ sum(is.na(.x)))
```

# Examining the *unprocessed* Google mobility data for the United States

```{r raw-us-unique-country-codes}
raw_us_data %>%
  pull(country_region) %>%
  unique()
```

```{r raw-us-data-states}
raw_us_data %>%
  pull(sub_region_1) %>%
  unique()
```

```{r raw-us-data-sub-region-counts}
raw_us_data %>%
  count(sub_region_1, sub_region_2)
```

```{r raw-us-data-date-ranges}
raw_us_data %>%
  group_by(sub_region_1) %>%
  summarize(
    min = min(date),
    max = max(date)
  )
```

# Examining the *processed* Google mobility data for the United States

```{r us-data-states}
us_data %>%
  pull(sub_region_1) %>%
  unique()
```

# Examining the state-level data

```{r state-level-missing-values}
state_level_data %>%
  map(~ sum(is.na(.x)))
```

# Examining the $R_t$ data

```{r rt-states}
rt_data %>%
  pull(region) %>%
  unique()
```

```{r rt-states-count}
rt_data %>%
  pull(region) %>%
  n_distinct()
```

# Density by region

```{r density-by-region, fig.width=8}
ggplot(pop_density_data, aes(region, density)) +
  geom_point() +
  geom_segment(aes(x = region, y = 0, xend = region, yend = density)) +
  theme(axis.text.x = element_text(angle = 90, size = 8, vjust = 0.5))
```

# Examining the model data

<!-- TODO -->

# Examining the random forest models

## Plain model (run on entire data set)

```{r rf-plain-model-importance}
model_list <- rf_model_list$plain
mse_scores <- model_list %>% map(~ .x$mse)
best_model <- model_list[[which.min(mse_scores)]]$model
importance(best_model)
```

```{r rf-plain-model-importance-plot, fig.width=8}
varImpPlot(best_model)
```

## Model excluding DC

```{r rf-no_dc-model-importance}
model_list <- rf_model_list$no_dc
mse_scores <- model_list %>% map(~ .x$mse)
best_model <- model_list[[which.min(mse_scores)]]$model
importance(best_model)
```

```{r rf-no_dc-model-importance-plot, fig.width=8}
varImpPlot(best_model)
```

## Model excluding NY

```{r rf-no_ny-model-importance}
model_list <- rf_model_list$no_ny
mse_scores <- model_list %>% map(~ .x$mse)
best_model <- model_list[[which.min(mse_scores)]]$model
importance(best_model)
```

```{r rf-no_ny-model-importance-plot, fig.width=8}
varImpPlot(best_model)
```

## Model excluding highest density states (CT, DC, MA, MD, NJ, and RI)

```{r rf-low_density-model-importance}
model_list <- rf_model_list$low_density
mse_scores <- model_list %>% map(~ .x$mse)
best_model <- model_list[[which.min(mse_scores)]]$model
importance(best_model)
```

```{r rf-low_density-model-importance-plot, fig.width=8}
varImpPlot(best_model)
```

# Session info

```{r session-info}
sessionInfo()
```
